!function(){"use strict";angular.module("sync",["socketio-auth"]).config(["$socketioProvider",function(n){n.setDebug(!0)}])}(),function(){"use strict";function n(){function n(n){s=n}function t(){return s}function e(){return u.length}function i(n){u.push({timestamp:Date.now(),collect:n}),c||a.schedule()}function r(){return s?(c=!0,void setTimeout(function(){a.run(),u.length>0?r():c=!1},1e3*s)):void a.run()}function o(){for(var n=Date.now()-1e3*s;u.length>0&&u[0].timestamp<=n;)u.shift().collect()}var u=[],s=2,c=!1,a={setSeconds:n,getSeconds:t,dispose:i,schedule:r,run:o,getItemCount:e};return a}angular.module("sync").factory("$syncGarbageCollector",n)}(),function(){"use strict";function n(){function n(i,r,o){if(!i)return r;var u={};for(var s in r)_.isArray(r[s])?u[s]=t(i[s],r[s],o):_.isFunction(r[s])?u[s]=r[s]:_.isObject(r[s])?u[s]=n(i[s],r[s],o):u[s]=r[s];return e(i),_.assign(i,u),i}function t(t,e,i){if(!t)return e;var r=[];return e.forEach(function(e){if(i)if(!_.isArray(e)&&_.isObject(e))if(angular.isDefined(e.id))r.push(n(_.find(t,{id:e.id}),e,i));else{if(i)throw new Error("objects in array must have an id otherwise we can't maintain the instance reference. "+JSON.stringify(e));r.push(e)}else r.push(e);else r.push(e)}),t.length=0,Array.prototype.push.apply(t,r),t}function e(n){Object.keys(n).forEach(function(t){delete n[t]})}return{merge:n,clearObject:e}}angular.module("sync").factory("$syncMerge",n)}(),function(){"use strict";function n(){function n(n){}function t(n){}var e;this.setDebug=function(n){e=n},this.$get=["$rootScope","$q","$socketio","$syncGarbageCollector","$syncMerge",function(e,i,r,o,u){function s(t,e,r){var o=i.defer(),u=a(t).setObjectClass(r),s=setTimeout(function(){u.ready||(u.destroy(),n("Attempt to subscribe to publication "+t+" failed"),o.reject("SYNC_TIMEOUT"))},1e3*v);return u.setParameters(e).waitForDataReady().then(function(){clearTimeout(s),o.resolve(u)})["catch"](function(){clearTimeout(s),u.destroy(),o.reject("Failed to subscribe to publication "+t+" failed")}),o.promise}function c(){return v}function a(n,t){return new l(n,t)}function f(){r.on("SYNC_NOW",function(t,e){n("Syncing with subscription [name:"+t.name+", id:"+t.subscriptionId+" , params:"+JSON.stringify(t.params)+"]. Records:"+t.records.length+"["+(t.diff?"Diff":"All")+"]");var i=y[t.name];if(i)for(var r in i)i[r](t);e("SYNCED")})}function d(n,t){var e=m++,i=y[n];return i||(y[n]=i={}),i[e]=t,function(){delete i[e]}}function l(s,c){function a(){D()}function f(n){return Z&&Z(),Z=M(n),an}function l(n){return n&&an.syncOff(),an}function y(n){X=!0}function m(n){return V?an:(on=n,nn=function(n){return new on(n)},O(B),an)}function v(){return on}function g(n,t){return cn&&angular.equals(n,fn)?an:(D(),B||(K.length=0),fn=n||{},t=t||{},angular.isDefined(t.single)&&O(t.single),j(),an)}function b(){return V.promise.then(function(){return an})}function S(){return V.promise}function O(n){if(V)return an;var t;return B=n,n?(t=L,K=on?new on({}):{}):(t=W,K=[]),H=function(n){try{t(n)}catch(e){throw e.message="Received Invalid object from publication ["+s+"]: "+JSON.stringify(n)+". DETAILS: "+e.message,e}},an}function w(){return K}function j(){return cn?V.promise:(V=i.defer(),Q=!1,n("Sync "+s+" on. Params:"+JSON.stringify(fn)),cn=!0,N(),R(),V.promise)}function D(){V&&V.resolve(w()),cn&&(C(),cn=!1,n("Sync "+s+" off. Params:"+JSON.stringify(fn)),en&&(en(),en=null),tn&&(tn(),tn=null))}function $(){return cn}function R(){en||(E(),T())}function _(n){return V?an:(rn&&rn(),sn=n,rn=sn.$on("$destroy",a),an)}function E(n){setTimeout(function(){tn=sn.$on("user_connected",function(){t("Resyncing after network loss to "+s),N()})},n?0:2e3)}function N(){r.fetch("sync.subscribe",{version:p,id:un,publication:s,params:fn}).then(function(n){un=n})}function C(){un&&(r.fetch("sync.unsubscribe",{version:p,id:un}),un=null)}function T(){en=d(s,function(n){(un===n.subscriptionId||!un&&k(n.params))&&(n.diff||(dn={},B||(K.length=0)),A(n.records),Q||(Q=!0,V.resolve(w())))})}function k(n){if(!fn||0==Object.keys(fn).length)return!0;var t=!0;for(var e in n)if(n[e]!==fn[e]){t=!1;break}return t}function A(n){var t,e=[];an.ready=!1,n.forEach(function(n){n.remove?U(n):t=dn[n.id]?G(n):q(n),t&&e.push(t)}),an.ready=!0,B?ln.notify("ready",w()):ln.notify("ready",w(),e)}function F(){return this.ready}function I(n){return ln.on("add",n)}function P(n){return ln.on("update",n)}function J(n){return ln.on("remove",n)}function M(n){return ln.on("ready",n)}function q(n){return t("Sync -> Inserted New record #"+n.id+" for subscription to "+s),z(n),H(nn?nn(n):n),ln.notify("add",n),n}function G(n){var e=dn[n.id];return z(n)<=z(e)?null:(t("Sync -> Updated record #"+n.id+" for subscription to "+s),H(nn?nn(n):n),ln.notify("update",n),n)}function U(n){var e=dn[n.id];(!e||z(n)>z(e))&&(t("Sync -> Removed #"+n.id+" for subscription to "+s),n.removed=!0,H(n),e&&(ln.notify("remove",n),Y(n)))}function Y(n){o.dispose(function(){var t=dn[n.id];t&&n.revision>=t.revision&&delete dn[n.id]})}function x(n){return!!dn[n]}function L(n){dn[n.id]=n,n.remove?u.clearObject(K):u.merge(K,n,X)}function W(n){var t=dn[n.id];t?(u.merge(t,n,X),n.removed&&K.splice(K.indexOf(t),1)):(dn[n.id]=n,n.removed||K.push(n))}function z(n){if(angular.isDefined(n.revision))return n.revision;if(angular.isDefined(n.timestamp))return n.timestamp;throw new Error("Sync requires a revision or timestamp property in received "+(on?"object ["+on.name+"]":"record"))}var B,H,K,Q,V,X,Z,nn,tn,en,rn,on,un,sn,cn=!1,an=this,fn={},dn={},ln=new h;this.ready=!1,this.syncOn=j,this.syncOff=D,this.setOnReady=f,this.onReady=M,this.onUpdate=P,this.onAdd=I,this.onRemove=J,this.getData=w,this.setParameters=g,this.waitForDataReady=S,this.waitForSubscriptionReady=b,this.setForce=l,this.isSyncing=$,this.isReady=F,this.setSingle=O,this.setObjectClass=m,this.getObjectClass=v,this.setStrictMode=y,this.attach=_,this.destroy=a,this.isExistingStateFor=x,O(!1),_(c||e)}function h(){function n(n,t,i){var r=e[n];r&&_.forEach(r,function(n,e){n(t,i)})}function t(n,t){var r=e[n];r||(r=e[n]={});var o=i++;return r[o++]=t,function(){delete r[o]}}var e={},i=0;this.notify=n,this.on=t}var y={},m=0,v=8,p="1.1";f();var g={subscribe:a,resolveSubscription:s,getGracePeriod:c};return g}]}angular.module("sync").provider("$sync",n)}();