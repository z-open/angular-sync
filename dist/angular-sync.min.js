!function(){"use strict";angular.module("sync",["socketio-auth"]).config(["$socketioProvider",function(n){n.setDebug(!0)}])}(),function(){"use strict";function n(){function n(n){c=n}function t(){return c}function e(){return u.length}function r(n){u.push({timestamp:Date.now(),collect:n}),s||f.schedule()}function i(){return c?(s=!0,void setTimeout(function(){f.run(),u.length>0?i():s=!1},1e3*c)):void f.run()}function o(){for(var n=Date.now()-1e3*c;u.length>0&&u[0].timestamp<=n;)u.shift().collect()}var u=[],c=2,s=!1,f={setSeconds:n,getSeconds:t,dispose:r,schedule:i,run:o,getItemCount:e};return f}angular.module("sync").factory("$syncGarbageCollector",n)}(),function(){"use strict";function n(){function n(r,i,o){if(!r)return i;var u={};for(var c in i)_.isArray(i[c])?u[c]=t(r[c],i[c],o):_.isFunction(i[c])?u[c]=i[c]:_.isObject(i[c])?u[c]=n(r[c],i[c],o):u[c]=i[c];return e(r),_.assign(r,u),r}function t(t,e,r){if(!t)return e;var i=[];return e.forEach(function(e){if("NONE"===r)i.push(e);else if(!_.isArray(e)&&_.isObject(e))if(angular.isDefined(e.id))i.push(n(_.find(t,function(n){return n.id.toString()===e.id.toString()}),e,r));else{if(r)throw new Error("objects in array must have an id otherwise we can't maintain the instance reference. "+JSON.stringify(e));i.push(e)}else i.push(e)}),t.length=0,Array.prototype.push.apply(t,i),t}function e(n){Object.keys(n).forEach(function(t){delete n[t]})}return{merge:n,clearObject:e}}angular.module("sync").factory("$syncMerge",n)}(),function(){"use strict";function n(){function n(n){if(!_.isObject(n))return n;var t=_.join(_.map(n,function(n){return n}),"~");return t}function t(n){}function e(n){}var r;this.setDebug=function(n){r=n},this.$get=["$rootScope","$q","$socketio","$syncGarbageCollector","$syncMerge",function(r,i,o,u,c){function s(n,e,r){var o=i.defer(),u=a(n).setObjectClass(r),c=setTimeout(function(){u.ready||(u.destroy(),t("Attempt to subscribe to publication "+n+" failed"),o.reject("SYNC_TIMEOUT"))},1e3*v);return u.setParameters(e).waitForDataReady().then(function(){clearTimeout(c),o.resolve(u)})["catch"](function(){clearTimeout(c),u.destroy(),o.reject("Failed to subscribe to publication "+n+" failed")}),o.promise}function f(){return v}function a(n,t){return new h(n,t)}function d(){o.on("SYNC_NOW",function(n,e){t("Syncing with subscription [name:"+n.name+", id:"+n.subscriptionId+" , params:"+JSON.stringify(n.params)+"]. Records:"+n.records.length+"["+(n.diff?"Diff":"All")+"]");var r=m[n.name];if(r)for(var i in r)r[i](n);e("SYNCED")})}function l(n,t){var e=g++,r=m[n];return r||(m[n]=r={}),r[e]=t,function(){delete r[e]}}function h(s,f){function a(){_()}function d(n){return en&&en(),en=q(n),ln}function h(n){return n&&ln.syncOff(),ln}function m(n){tn=!0}function g(n){return nn?ln:(sn=n,rn=function(n){return new sn(n)},w(K),ln)}function v(){return sn}function b(n,t){return dn&&angular.equals(n,hn)?ln:(_(),K||(X.length=0),hn=n||{},t=t||{},angular.isDefined(t.single)&&w(t.single),D(),ln)}function S(){return nn.promise.then(function(){return ln})}function O(){return nn.promise}function w(n){if(nn)return ln;var t;return K=n,n?(t=z,X=sn?new sn({}):{}):(t=B,X=[]),Q=function(n){try{t(n)}catch(e){throw e.message="Received Invalid object from publication ["+s+"]: "+JSON.stringify(n)+". DETAILS: "+e.message,e}},ln}function j(){return X}function D(){return dn?nn.promise:(nn=i.defer(),Z=!1,t("Sync "+s+" on. Params:"+JSON.stringify(hn)),dn=!0,C(),N(),nn.promise)}function _(){nn&&nn.resolve(j()),dn&&(I(),dn=!1,t("Sync "+s+" off. Params:"+JSON.stringify(hn)),un&&(un(),un=null),on&&(on(),on=null))}function $(){return dn}function N(){un||(R(),T())}function E(n){return nn?ln:(cn&&cn(),an=n,cn=an.$on("$destroy",a),ln)}function R(n){setTimeout(function(){on=an.$on("user_connected",function(){e("Resyncing after network loss to "+s),C()})},n?0:2e3)}function C(){o.fetch("sync.subscribe",{version:p,id:fn,publication:s,params:hn}).then(function(n){fn=n})}function I(){fn&&(o.fetch("sync.unsubscribe",{version:p,id:fn}),fn=null)}function T(){un=l(s,function(n){(fn===n.subscriptionId||!fn&&k(n.params))&&(n.diff||(yn={},K||(X.length=0)),A(n.records),Z||(Z=!0,nn.resolve(j())))})}function k(n){if(!hn||0==Object.keys(hn).length)return!0;var t=!0;for(var e in n)if(n[e]!==hn[e]){t=!1;break}return t}function A(n){var t,e=[];ln.ready=!1,n.forEach(function(n){n.remove?Y(n):t=W(n)?U(n):G(n),t&&e.push(t)}),ln.ready=!0,K?mn.notify("ready",j()):mn.notify("ready",j(),e)}function F(){return this.ready}function P(n){return mn.on("add",n)}function J(n){return mn.on("update",n)}function M(n){return mn.on("remove",n)}function q(n){return mn.on("ready",n)}function G(n){return e("Sync -> Inserted New record #"+n.id.toString()+" for subscription to "+s),H(n),Q(rn?rn(n):n),mn.notify("add",n),n}function U(n){var t=W(n);return H(n)<=H(t)?null:(e("Sync -> Updated record #"+n.id.toString()+" for subscription to "+s),Q(rn?rn(n):n),mn.notify("update",n),n)}function Y(n){var t=W(n);(!t||H(n)>H(t))&&(e("Sync -> Removed #"+n.id.toString()+" for subscription to "+s),n.removed=!0,Q(n),t&&(mn.notify("remove",n),x(n)))}function x(t){u.dispose(function(){var e=W(t);e&&t.revision>=e.revision&&delete yn[n(t.id)]})}function L(n){return!!W(n)}function V(t){yn[n(t.id)]=t}function W(t){return yn[n(t.id)]}function z(n){V(n),n.remove?c.clearObject(X):c.merge(X,n,tn)}function B(n){var t=W(n);t?(c.merge(t,n,tn),n.removed&&X.splice(X.indexOf(t),1)):(V(n),n.removed||X.push(n))}function H(n){if(angular.isDefined(n.revision))return n.revision;if(angular.isDefined(n.timestamp))return n.timestamp;throw new Error("Sync requires a revision or timestamp property in received "+(sn?"object ["+sn.name+"]":"record"))}var K,Q,X,Z,nn,tn,en,rn,on,un,cn,sn,fn,an,dn=!1,ln=this,hn={},yn={},mn=new y;this.ready=!1,this.syncOn=D,this.syncOff=_,this.setOnReady=d,this.onReady=q,this.onUpdate=J,this.onAdd=P,this.onRemove=M,this.getData=j,this.setParameters=b,this.waitForDataReady=O,this.waitForSubscriptionReady=S,this.setForce=h,this.isSyncing=$,this.isReady=F,this.setSingle=w,this.setObjectClass=g,this.getObjectClass=v,this.setStrictMode=m,this.attach=E,this.destroy=a,this.isExistingStateFor=L,w(!1),E(f||r)}function y(){function n(n,t,r){var i=e[n];i&&_.forEach(i,function(n,e){n(t,r)})}function t(n,t){var i=e[n];i||(i=e[n]={});var o=r++;return i[o++]=t,function(){delete i[o]}}var e={},r=0;this.notify=n,this.on=t}var m={},g=0,v=8,p="1.2";d();var b={subscribe:a,resolveSubscription:s,getGracePeriod:f,getIdValue:n};return b}]}angular.module("sync").provider("$sync",n)}();