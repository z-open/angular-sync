!function(){"use strict";angular.module("sync",["socketio-auth"])}(),function(){"use strict";function n(){function n(n){c=n}function t(){return c}function e(){return u.length}function i(n){u.push({timestamp:Date.now(),collect:n}),s||a.schedule()}function r(){return c?(s=!0,void setTimeout(function(){a.run(),u.length>0?r():s=!1},1e3*c)):void a.run()}function o(){for(var n=Date.now()-1e3*c;u.length>0&&u[0].timestamp<=n;)u.shift().collect()}var u=[],c=2,s=!1,a={setSeconds:n,getSeconds:t,dispose:i,schedule:r,run:o,getItemCount:e};return a}angular.module("sync").factory("$syncGarbageCollector",n)}(),function(){"use strict";function n(){function n(i,r,o){if(!i)return r;var u={};for(var c in r)_.isArray(r[c])?u[c]=t(i[c],r[c],o):_.isFunction(r[c])?u[c]=r[c]:_.isObject(r[c])&&!_.isDate(r[c])?u[c]=n(i[c],r[c],o):u[c]=r[c];return e(i),_.assign(i,u),i}function t(t,e,i){if(!t)return e;var r=[];return e.forEach(function(e){if("NONE"===i)r.push(e);else if(!_.isArray(e)&&_.isObject(e))if(angular.isDefined(e.id))r.push(n(_.find(t,function(n){return n.id.toString()===e.id.toString()}),e,i));else{if(i)throw new Error("objects in array must have an id otherwise we can't maintain the instance reference. "+JSON.stringify(e));r.push(e)}else r.push(e)}),t.length=0,Array.prototype.push.apply(t,r),t}function e(n){Object.keys(n).forEach(function(t){delete n[t]})}return{update:n,clearObject:e}}angular.module("sync").factory("$syncMerge",n)}(),function(){"use strict";function n(){function n(n){if(!_.isObject(n))return n;var t=_.join(_.map(n,function(n){return n}),"~");return t}function t(n){}function e(n){}var i;this.setDebug=function(n){i=n},this.$get=["$rootScope","$q","$socketio","$syncGarbageCollector","$syncMerge",function(i,r,o,u,c){function s(n,e,i){var o=r.defer(),u=f(n).setObjectClass(i),c=setTimeout(function(){u.ready||(u.destroy(),t("Attempt to subscribe to publication "+n+" failed"),o.reject("SYNC_TIMEOUT"))},1e3*m);return u.setParameters(e).waitForDataReady().then(function(){clearTimeout(c),o.resolve(u)})["catch"](function(){clearTimeout(c),u.destroy(),o.reject("Failed to subscribe to publication "+n+" failed")}),o.promise}function a(){return m}function f(n,t){return new h(n,t)}function d(){o.on("SYNC_NOW",function(n,e){t("Syncing with subscription [name:"+n.name+", id:"+n.subscriptionId+" , params:"+JSON.stringify(n.params)+"]. Records:"+n.records.length+"["+(n.diff?"Diff":"All")+"]");var i=v[n.name];if(i)for(var r in i)i[r](n);e("SYNCED")})}function l(n,t){var e=p++,i=v[n];return i||(v[n]=i={}),i[e]=t,function(){delete i[e]}}function h(s,a){function f(){_()}function d(n){return en&&en(),en=q(n),ln}function h(n){return n&&ln.syncOff(),ln}function v(n){return tn=n,ln}function p(n){return nn?ln:(sn=n,rn=function(n){return new sn(n)},w(K),ln)}function m(){return sn}function b(n,t){return dn&&angular.equals(n||{},hn)?ln:(_(),K||(X.length=0),hn=n||{},t=t||{},angular.isDefined(t.single)&&w(t.single),N(),ln)}function S(){return N().then(function(){return ln})}function O(){return N()}function w(n){if(nn)return ln;var t;return K=n,n?(t=z,X=sn?new sn({}):{}):(t=B,X=[]),Q=function(n){try{t(n)}catch(e){throw e.message="Received Invalid object from publication ["+s+"]: "+JSON.stringify(n)+". DETAILS: "+e.message,e}},ln}function j(){return X}function N(){return dn?nn.promise:(nn=r.defer(),Z=!1,t("Sync "+s+" on. Params:"+JSON.stringify(hn)),dn=!0,C(),$(),nn.promise)}function _(){nn&&nn.resolve(j()),dn&&(I(),dn=!1,t("Sync "+s+" off. Params:"+JSON.stringify(hn)),un&&(un(),un=null),on&&(on(),on=null))}function D(){return dn}function $(){un||(R(),J())}function E(n){return nn?ln:(cn&&cn(),fn=n,cn=fn.$on("$destroy",f),ln)}function R(n){setTimeout(function(){on=fn.$on("user_connected",function(){e("Resyncing after network loss to "+s),C()})},n?0:2e3)}function C(){o.fetch("sync.subscribe",{version:g,id:an,publication:s,params:hn}).then(function(n){an=n})}function I(){an&&(o.fetch("sync.unsubscribe",{version:g,id:an}),an=null)}function J(){un=l(s,function(n){(an===n.subscriptionId||!an&&T(n.params))&&(n.diff||(yn={},K||(X.length=0)),A(n.records),Z||(Z=!0,nn.resolve(j())))})}function T(n){if(!hn||0==Object.keys(hn).length)return!0;var t=!0;for(var e in n)if(n[e]!==hn[e]){t=!1;break}return t}function A(n){var t,e=[];ln.ready=!1,n.forEach(function(n){n.remove?Y(n):t=W(n)?U(n):G(n),t&&e.push(t)}),ln.ready=!0,K?vn.notify("ready",j()):vn.notify("ready",j(),e)}function F(){return this.ready}function k(n){return vn.on("add",n)}function P(n){return vn.on("update",n)}function M(n){return vn.on("remove",n)}function q(n){return vn.on("ready",n)}function G(n){return e("Sync -> Inserted New record #"+JSON.stringify(n.id)+" for subscription to "+s),H(n),Q(rn?rn(n):n),vn.notify("add",n),n}function U(n){var t=W(n);return H(n)<=H(t)?null:(e("Sync -> Updated record #"+JSON.stringify(n.id)+" for subscription to "+s),Q(rn?rn(n):n),vn.notify("update",n),n)}function Y(n){var t=W(n);(!t||H(n)>H(t))&&(e("Sync -> Removed #"+JSON.stringify(n.id)+" for subscription to "+s),n.removed=!0,Q(n),t&&(vn.notify("remove",n),x(n)))}function x(t){u.dispose(function(){var e=W(t);e&&t.revision>=e.revision&&delete yn[n(t.id)]})}function L(n){return!!W(n)}function V(t){yn[n(t.id)]=t}function W(t){return yn[n(t.id)]}function z(n){V(n),n.remove?c.clearObject(X):c.update(X,n,tn)}function B(n){var t=W(n);t?(c.update(t,n,tn),n.removed&&X.splice(X.indexOf(t),1)):(V(n),n.removed||X.push(n))}function H(n){if(angular.isDefined(n.revision))return n.revision;if(angular.isDefined(n.timestamp))return n.timestamp;throw new Error("Sync requires a revision or timestamp property in received "+(sn?"object ["+sn.name+"]":"record"))}var K,Q,X,Z,nn,tn,en,rn,on,un,cn,sn,an,fn,dn=!1,ln=this,hn={},yn={},vn=new y;this.ready=!1,this.syncOn=N,this.syncOff=_,this.setOnReady=d,this.onReady=q,this.onUpdate=P,this.onAdd=k,this.onRemove=M,this.getData=j,this.setParameters=b,this.waitForDataReady=O,this.waitForSubscriptionReady=S,this.setForce=h,this.isSyncing=D,this.isReady=F,this.setSingle=w,this.setObjectClass=p,this.getObjectClass=m,this.setStrictMode=v,this.attach=E,this.destroy=f,this.isExistingStateFor=L,w(!1),E(a||i)}function y(){function n(n,t,i){var r=e[n];r&&_.forEach(r,function(n,e){n(t,i)})}function t(n,t){var r=e[n];r||(r=e[n]={});var o=i++;return r[o++]=t,function(){delete r[o]}}var e={},i=0;this.notify=n,this.on=t}var v={},p=0,m=8,g="1.2";d();var b={subscribe:f,resolveSubscription:s,getGracePeriod:a,getIdValue:n};return b}]}angular.module("sync").provider("$sync",n)}();