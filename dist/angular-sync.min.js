!function(){"use strict";angular.module("sync",["socketio-auth"])}(),function(){"use strict";function n(){function n(n){s=n}function t(){return s}function e(){return u.length}function r(n){u.push({timestamp:Date.now(),collect:n}),c||a.schedule()}function i(){return s?(c=!0,void setTimeout(function(){a.run(),u.length>0?i():c=!1},1e3*s)):void a.run()}function o(){for(var n=Date.now()-1e3*s;u.length>0&&u[0].timestamp<=n;)u.shift().collect()}var u=[],s=2,c=!1,a={setSeconds:n,getSeconds:t,dispose:r,schedule:i,run:o,getItemCount:e};return a}angular.module("sync").factory("$syncGarbageCollector",n)}(),function(){"use strict";function n(){function n(n,e,r){function i(n){if(!(_.isArray(n)||_.isObject(n)||_.isDate(n)||_.isFunction(n)))return null;var t=_.find(s,function(t){return n===t.value});return t?t.newValue:null}function o(n,e,r){if(!n)return e;var c={};for(var a in e){var f=i(e[a]),d=Object.getOwnPropertyDescriptor(e,a);f?c[a]=f:d&&(d.set||d.get)||(_.isArray(e[a])?(c[a]=u(n[a],e[a],r),s.push({value:e[a],newValue:c[a]})):_.isFunction(e[a])?(c[a]=e[a],s.push({value:e[a],newValue:c[a]})):_.isObject(e[a])&&!_.isDate(e[a])?(c[a]=o(n[a],e[a],r),s.push({value:e[a],newValue:c[a]})):c[a]=e[a])}return t(n),_.assign(n,c),n}function u(n,t,e){if(!n)return t;var r=[];return t.forEach(function(t){var u=i(t);if(u)r.push(u);else if("NONE"===e)r.push(t);else if(!_.isArray(t)&&_.isObject(t))if(angular.isDefined(t.id))r.push(o(_.find(n,function(n){return n.id.toString()===t.id.toString()}),t,e));else{if(e)throw new Error("objects in array must have an id otherwise we can't maintain the instance reference. "+JSON.stringify(t));r.push(t)}else r.push(t)}),n.length=0,Array.prototype.push.apply(n,r),n}var s=[];return o(n,e,r)}function t(n){Object.keys(n).forEach(function(t){delete n[t]})}return{update:n,clearObject:t}}angular.module("sync").factory("$syncMerge",n)}(),function(){"use strict";function n(){function n(n){if(!_.isObject(n))return n;var t=_.join(_.map(n,function(n){return n}),"~");return t}function t(n){}function e(n){}var r;this.setDebug=function(n){r=n},this.$get=["$rootScope","$q","$socketio","$syncGarbageCollector","$syncMerge",function(r,i,o,u,s){function c(n,e,r){var o=i.defer(),u=f(n).setObjectClass(r),s=setTimeout(function(){u.ready||(u.destroy(),t("Attempt to subscribe to publication "+n+" failed"),o.reject("SYNC_TIMEOUT"))},1e3*g);return u.setParameters(e).waitForDataReady().then(function(){clearTimeout(s),o.resolve(u)})["catch"](function(){clearTimeout(s),u.destroy(),o.reject("Failed to subscribe to publication "+n+" failed")}),o.promise}function a(){return g}function f(n,t){return new h(n,t)}function d(){o.on("SYNC_NOW",function(n,e){t("Syncing with subscription [name:"+n.name+", id:"+n.subscriptionId+" , params:"+JSON.stringify(n.params)+"]. Records:"+n.records.length+"["+(n.diff?"Diff":"All")+"]");var r=v[n.name];if(r)for(var i in r)r[i](n);e("SYNCED")})}function l(n,t){var e=p++,r=v[n];return r||(v[n]=r={}),r[e]=t,function(){delete r[e]}}function h(c,a){function f(){D()}function d(n){return rn&&rn(),rn=q(n),hn}function h(n){return n&&hn.syncOff(),hn}function v(n){return en=n,hn}function p(n){return tn?hn:(an=n,on=function(n){return new an(n)},w(Q),hn)}function g(){return an}function b(n,t){return ln&&angular.equals(n||{},yn)?hn:(D(),Q||(Z.length=0),yn=n||{},t=t||{},angular.isDefined(t.single)&&w(t.single),N(),hn)}function S(){return N().then(function(){return hn})}function O(){return N()}function w(n){if(tn)return hn;var t;return Q=n,n?(t=B,Z=an?new an({}):{}):(t=H,Z=[]),X=function(n){try{t(n)}catch(e){throw e.message="Received Invalid object from publication ["+c+"]: "+JSON.stringify(n)+". DETAILS: "+e.message,e}},hn}function _(){return Z}function j(){return N(),hn}function D(){return tn&&tn.resolve(_()),ln&&(F(),ln=!1,t("Sync "+c+" off. Params:"+JSON.stringify(yn)),sn&&(sn(),sn=null),un&&(un(),un=null)),hn}function N(){return ln?tn.promise:(tn=i.defer(),nn=!1,t("Sync "+c+" on. Params:"+JSON.stringify(yn)),ln=!0,A(),E(),tn.promise)}function $(){return ln}function E(){sn||(C(),I())}function R(n){return tn?hn:(cn&&cn(),dn=n,cn=dn.$on("$destroy",f),hn)}function C(n){setTimeout(function(){un=dn.$on("user_connected",function(){e("Resyncing after network loss to "+c),A()})},n?0:2e3)}function A(){o.fetch("sync.subscribe",{version:m,id:fn,publication:c,params:yn}).then(function(n){fn=n})}function F(){fn&&(o.fetch("sync.unsubscribe",{version:m,id:fn}),fn=null)}function I(){sn=l(c,function(n){(fn===n.subscriptionId||!fn&&J(n.params))&&(n.diff||(vn={},Q||(Z.length=0)),T(n.records),nn||(nn=!0,tn.resolve(_())))})}function J(n){if(!yn||0==Object.keys(yn).length)return!0;var t=!0;for(var e in n)if(n[e]!==yn[e]){t=!1;break}return t}function T(n){var t,e=[];hn.ready=!1,n.forEach(function(n){n.remove?Y(n):t=z(n)?U(n):G(n),t&&e.push(t)}),hn.ready=!0,Q?pn.notify("ready",_()):pn.notify("ready",_(),e)}function k(){return this.ready}function P(n){return pn.on("add",n)}function V(n){return pn.on("update",n)}function M(n){return pn.on("remove",n)}function q(n){return pn.on("ready",n)}function G(n){return e("Sync -> Inserted New record #"+JSON.stringify(n.id)+" for subscription to "+c),K(n),X(on?on(n):n),pn.notify("add",n),n}function U(n){var t=z(n);return K(n)<=K(t)?null:(e("Sync -> Updated record #"+JSON.stringify(n.id)+" for subscription to "+c),X(on?on(n):n),pn.notify("update",n),n)}function Y(n){var t=z(n);(!t||K(n)>K(t))&&(e("Sync -> Removed #"+JSON.stringify(n.id)+" for subscription to "+c),n.removed=!0,X(n),t&&(pn.notify("remove",n),x(n)))}function x(t){u.dispose(function(){var e=z(t);e&&t.revision>=e.revision&&delete vn[n(t.id)]})}function L(n){return!!z(n)}function W(t){vn[n(t.id)]=t}function z(t){return vn[n(t.id)]}function B(n){W(n),n.remove?s.clearObject(Z):s.update(Z,n,en)}function H(n){var t=z(n);t?(s.update(t,n,en),n.removed&&Z.splice(Z.indexOf(t),1)):(W(n),n.removed||Z.push(n))}function K(n){if(angular.isDefined(n.revision))return n.revision;if(angular.isDefined(n.timestamp))return n.timestamp;throw new Error("Sync requires a revision or timestamp property in received "+(an?"object ["+an.name+"]":"record"))}var Q,X,Z,nn,tn,en,rn,on,un,sn,cn,an,fn,dn,ln=!1,hn=this,yn={},vn={},pn=new y;this.ready=!1,this.syncOn=j,this.syncOff=D,this.setOnReady=d,this.onReady=q,this.onUpdate=V,this.onAdd=P,this.onRemove=M,this.getData=_,this.setParameters=b,this.waitForDataReady=O,this.waitForSubscriptionReady=S,this.setForce=h,this.isSyncing=$,this.isReady=k,this.setSingle=w,this.setObjectClass=p,this.getObjectClass=g,this.setStrictMode=v,this.attach=R,this.destroy=f,this.isExistingStateFor=L,w(!1),R(a||r)}function y(){function n(n,t,r){var i=e[n];i&&_.forEach(i,function(n,e){n(t,r)})}function t(n,t){var i=e[n];i||(i=e[n]={});var o=r++;return i[o++]=t,function(){delete i[o]}}var e={},r=0;this.notify=n,this.on=t}var v={},p=0,g=8,m="1.2";d();var b={subscribe:f,resolveSubscription:c,getGracePeriod:a,getIdValue:n};return b}]}angular.module("sync").provider("$sync",n)}();